<div class="booking-detail-container">
  <button mat-flat-button color="accent" (click)="goBack()" class="back-button">
    <mat-icon>arrow_back</mat-icon> Volver a Mis Reservas
  </button>

  <div *ngIf="isLoading" class="loading-message">
    <mat-spinner></mat-spinner>
    <p>Cargando detalles de la reserva...</p>
  </div>

  <div *ngIf="error && !isLoading" class="error-message">
    <p>{{ error }}</p>
  </div>

  <mat-card *ngIf="alquiler && !isLoading && !error">
    <mat-card-header>
      <mat-card-title>Detalles de la Reserva</mat-card-title>
      <mat-card-subtitle>ID de Reserva: {{ alquiler.id }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="detail-section vehicle-info">
        <h3>Información del Vehículo</h3>
        <img [src]="currentVehicle?.mainImageUrl || 'https://placehold.co/400x300/CCCCCC/000000?text=No+Image'" alt="Imagen del vehículo" class="vehicle-image">
        <p><strong>Marca:</strong> {{ currentVehicle?.make || 'N/A' }}</p>
        <p><strong>Modelo:</strong> {{ currentVehicle?.model || 'N/A' }}</p>
        <p><strong>Año:</strong> {{ currentVehicle?.year || 'N/A' }}</p>
        <p><strong>Color:</strong> {{ currentVehicle?.color || 'N/A' }}</p>
        <p><strong>Matrícula:</strong> {{ currentVehicle?.licensePlate || 'N/A' }}</p>
        <p><strong>Tipo:</strong> {{ currentVehicle?.vehicleType || 'N/A' }} ({{ currentVehicle?.fuelType || 'N/A' }})</p>
        <p><strong>Descripción:</strong> {{ currentVehicle?.description || 'No description' }}</p>
      </div>

      <div class="detail-section booking-info">
        <h3>Detalles del Alquiler</h3>
        <p><strong>Fechas de Alquiler:</strong> {{ alquiler.startDate | date:'fullDate' }} al {{ alquiler.endDate | date:'fullDate' }}</p>
        <p><strong>Fecha de Reserva:</strong> {{ alquiler.bookingDate | date:'short' }}</p>
        <p><strong>Estado:</strong> <span [ngClass]="getStatusClass(alquiler.status)">{{ alquiler.status.replace('_', ' ') || 'N/A' }}</span></p>
        <p><strong>Costo Base por Día:</strong> ${{ currentPublication?.dailyPrice | number:'1.2-2' }}</p>
        <p><strong>Costo Total Estimado:</strong> ${{ alquiler.totalCost | number:'1.2-2' }}</p>
        <p><strong>Kilometraje de Recogida:</strong> {{ alquiler.pickupMileage || 'N/A' }} km</p>
        <p *ngIf="alquiler.dropoffMileage !== null"><strong>Kilometraje de Devolución:</strong> {{ alquiler.dropoffMileage }} km</p>
        <p><strong>Ubicación de Recogida:</strong> {{ currentPickupLocation?.addressLine1 || 'N/A' }}, {{ currentPickupLocation?.city || 'N/A' }}</p>
        <p *ngIf="currentDropoffLocation && currentPickupLocation?.id !== currentDropoffLocation.id">
          <strong>Ubicación de Devolución:</strong> {{ currentDropoffLocation.addressLine1 || 'N/A' }}, {{ currentDropoffLocation.city || 'N/A' }}
        </p>
      </div>

      <div class="detail-section parties-info">
        <h3>Información del Propietario</h3>
        <p><strong>Nombre:</strong> {{ currentOwner?.fullName || 'N/A' }}</p>
        <p><strong>Email:</strong> {{ currentOwner?.email || 'N/A' }}</p>
        <p><strong>Teléfono:</strong> {{ currentOwner?.phone || 'N/A' }}</p>
      </div>

      <div class="detail-section insurance-info" *ngIf="currentInsurance">
        <h3>Detalles del Seguro</h3>
        <p><strong>Plan:</strong> {{ currentInsurance.planName || 'N/A' }}</p>
        <p><strong>Costo Diario del Seguro:</strong> ${{ currentInsurance.dailyCost | number:'1.2-2' }}</p>
        <p><strong>Deducible:</strong> ${{ currentInsurance.deductible | number:'1.2-2' }}</p>
        <p><strong>Cobertura:</strong> {{ currentInsurance.coverageDetails || 'N/A' }}</p>
      </div>
    </mat-card-content>
    <mat-card-actions align="end">
      <button mat-raised-button color="warn" (click)="cancelBooking()"
              [disabled]="alquiler.status === 'CANCELLED' || alquiler.status === 'COMPLETED' || alquiler.status === 'REJECTED' || isLoading">
        <mat-icon>cancel</mat-icon> Cancelar Reserva
      </button>
    </mat-card-actions>
  </mat-card>
</div>
