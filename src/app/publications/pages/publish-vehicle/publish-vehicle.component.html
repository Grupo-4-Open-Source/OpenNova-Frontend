<div class="publish-page-container">
  <mat-card class="publish-card form-column">
    <mat-card-header>
      <mat-card-title>Publish a Vehicle</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="publishForm" (ngSubmit)="onSubmit()">
        <mat-card class="form-section-card">
          <mat-card-header>
            <mat-card-title>1. Vehicle Selection</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-radio-group formControlName="vehicleSelectionMode" aria-label="Select vehicle mode" class="vehicle-selection-radio-group">
              <mat-radio-button value="new">Register New Vehicle</mat-radio-button>
              <mat-radio-button value="existing" [disabled]="unpublishedVehicles.length === 0">Publish Existing Vehicle</mat-radio-button>
            </mat-radio-group>

            <div *ngIf="vehicleSelectionModeControl?.value === 'existing'" class="existing-vehicle-select">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Select an Existing Vehicle</mat-label>
                <mat-select formControlName="existingVehicleId">
                  <mat-option *ngIf="unpublishedVehicles.length === 0" disabled>No unpublished vehicles available.</mat-option>
                  <mat-option *ngFor="let vehicle of unpublishedVehicles" [value]="vehicle.id">
                    {{ vehicle.make }} {{ vehicle.model }} ({{ vehicle.licensePlate }})
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="publishForm.get('existingVehicleId')?.invalid && (publishForm.get('existingVehicleId')?.dirty || publishForm.get('existingVehicleId')?.touched)">
                  You must select an existing vehicle.
                </mat-error>
              </mat-form-field>
            </div>

            <div *ngIf="unpublishedVehicles.length === 0 && vehicleSelectionModeControl?.value === 'existing'" class="info-message">
              No existing unpublished vehicles found. Please register a new one first.
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="form-section-card" [formGroup]="publicacionDetails">
          <mat-card-header>
            <mat-card-title>2. Publication Details</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Listing Title</mat-label>
              <input matInput formControlName="title">
              <mat-error *ngIf="publicacionDetails.get('title')?.invalid && (publicacionDetails.get('title')?.dirty || publicacionDetails.get('title')?.touched)">Title is required.</mat-error>
            </mat-form-field>
            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Daily Price</mat-label>
                <input matInput type="number" formControlName="dailyPrice">
                <mat-error *ngIf="publicacionDetails.get('dailyPrice')?.invalid && (publicacionDetails.get('dailyPrice')?.dirty || publicacionDetails.get('dailyPrice')?.touched)">Daily price is required.</mat-error>
                <mat-error *ngIf="publicacionDetails.get('dailyPrice')?.hasError('min')">Price must be greater than 0.</mat-error>
              </mat-form-field>
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Weekly Price (Optional)</mat-label>
                <input matInput type="number" formControlName="weeklyPrice">
                <mat-error *ngIf="publicacionDetails.get('weeklyPrice')?.hasError('min')">Weekly price cannot be negative.</mat-error>
              </mat-form-field>
            </div>
            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Minimum Rental Days</mat-label>
                <input matInput type="number" formControlName="minRentalDays">
                <mat-error *ngIf="publicacionDetails.get('minRentalDays')?.invalid && (publicacionDetails.get('minRentalDays')?.dirty || publicacionDetails.get('minRentalDays')?.touched)">Minimum days are required.</mat-error>
                <mat-error *ngIf="publicacionDetails.get('minRentalDays')?.hasError('min')">Must be at least 1 day.</mat-error>
              </mat-form-field>
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Maximum Rental Days</mat-label>
                <input matInput type="number" formControlName="maxRentalDays">
                <mat-error *ngIf="publicacionDetails.get('maxRentalDays')?.invalid && (publicacionDetails.get('maxRentalDays')?.dirty || publicacionDetails.get('maxRentalDays')?.touched)">Maximum days are required.</mat-error>
                <mat-error *ngIf="publicacionDetails.get('maxRentalDays')?.hasError('min')">Must be at least 1 day.</mat-error>
              </mat-form-field>
            </div>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Car Rules</mat-label>
              <textarea matInput formControlName="carRules" rows="3"></textarea>
              <mat-error *ngIf="publicacionDetails.get('carRules')?.invalid && (publicacionDetails.get('carRules')?.dirty || publicacionDetails.get('carRules')?.touched)">Rules are required.</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Pickup Location</mat-label>
              <mat-select formControlName="pickupLocationId">
                <mat-option *ngFor="let location of locations" [value]="location.id">
                  {{ location.addressLine1 }}, {{ location.city }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="publicacionDetails.get('pickupLocationId')?.invalid && (publicacionDetails.get('pickupLocationId')?.dirty || publicacionDetails.get('pickupLocationId')?.touched)">Location is required.</mat-error>
            </mat-form-field>
            <mat-checkbox formControlName="isFeatured">Mark as Featured</mat-checkbox>
          </mat-card-content>
        </mat-card>

        <button mat-raised-button color="primary" type="submit" [disabled]="publishForm.invalid || isLoading" class="purple-button">
          <span *ngIf="!isLoading">Publish Vehicle</span>
          <span *ngIf="isLoading">Publishing...</span>
        </button>
      </form>
    </mat-card-content>
  </mat-card>

  <mat-card class="publish-card preview-column">
    <mat-card-header>
      <mat-card-title>Listing Preview</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <ng-container *ngIf="selectedExistingVehicle">
        <div class="preview-item">
          <h3 class="preview-title">{{ publicacionDetails.get('title')?.value || (selectedExistingVehicle.make + ' ' + selectedExistingVehicle.model) || 'Listing Title' }}</h3>
        </div>

        <div class="preview-image">
          <img [src]="selectedExistingVehicle.mainImageUrl || 'https://via.placeholder.com/400x250?text=Vehicle+Image'" alt="Vehicle main image">
        </div>

        <div class="preview-details">
          <p><strong>Make:</strong> {{ selectedExistingVehicle.make || 'N/A' }}</p>
          <p><strong>Model:</strong> {{ selectedExistingVehicle.model || 'N/A' }}</p>
          <p><strong>Year:</strong> {{ selectedExistingVehicle.year || 'N/A' }}</p>
          <p><strong>Type:</strong> {{ selectedExistingVehicle.vehicleType || 'N/A' }}</p>
          <p><strong>Capacity:</strong> {{ selectedExistingVehicle.passengerCapacity || 'N/A' }}</p>
          <p><strong>Description:</strong> {{ selectedExistingVehicle.description || 'No description' }}</p>
          <p><strong>Rules:</strong> {{ publicacionDetails.get('carRules')?.value || 'No rules specified' }}</p>
          <p><strong>Daily Price:</strong> ${{ publicacionDetails.get('dailyPrice')?.value || '0.00' }}</p>
          <p *ngIf="publicacionDetails.get('weeklyPrice')?.value"><strong>Weekly Price:</strong> ${{ publicacionDetails.get('weeklyPrice')?.value }}</p>
          <p><strong>Min. Rental Days:</strong> {{ publicacionDetails.get('minRentalDays')?.value || 'N/A' }}</p>
          <p><strong>Max. Rental Days:</strong> {{ publicacionDetails.get('maxRentalDays')?.value || 'N/A' }}</p>
        </div>
      </ng-container>

      <ng-template #newVehiclePreview>
        <div class="info-message">
          <p>Select an existing vehicle to see its preview here.</p>
        </div>
      </ng-template>
    </mat-card-content>
  </mat-card>
</div>
